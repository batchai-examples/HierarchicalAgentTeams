{
    "has_issue": true,
    "overall_severity": "minor",
    "issues": [
        {
            "short_description": "Improper exception handling for non-BaseError exceptions.",
            "detailed_explaination": "In the internal_exception_handler, if the exception is not an instance of BaseError, the code attempts to access exc.status_code, which may not exist for all exception types. This can lead to an AttributeError if exc does not have a status_code attribute.",
            "suggestion": "Ensure that the exception object has a status_code attribute before accessing it. You can use a default status code (like 500) if it doesn't exist.",
            "issue_line_begin": 43,
            "issue_line_end": 45,
            "issue_reference_urls": [
                "https://docs.python.org/3/tutorial/errors.html"
            ],
            "severity": "minor",
            "severity_reason": "This issue could lead to runtime errors if unexpected exceptions are raised."
        }
    ],
    "fixed_code": "from datetime import datetime, timezone\nimport http\nimport os\nfrom logging import Logger\nfrom langchain_core.messages import AIMessageChunk\nfrom fastapi import FastAPI, Request\nfrom fastapi.responses import JSONResponse, StreamingResponse\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom starlette.middleware.base import BaseHTTPMiddleware\n\n\nfrom dotenv import load_dotenv\nfrom misc import format_datetime\nfrom errs import BaseError\nfrom log import get_logger\nfrom graph import super_graph\n\nload_dotenv(dotenv_path=os.path.join(os.getcwd(), \".env\"))\n\n\nclass LoggingMiddleware(BaseHTTPMiddleware):\n    logger: Logger = get_logger(\"api\")\n\n    async def dispatch(self, request, call_next):\n        self.logger.info(\"Request body: %s\", await request.body())\n        resp = await call_next(request)\n        return resp\n    \n\nfastapi_app = FastAPI(validate_responses=False)\nfastapi_app.add_middleware(LoggingMiddleware)\nfastapi_app.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"], \n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n@fastapi_app.exception_handler(BaseError)\nasync def custom_exception_handler(request: Request, exc: BaseError):\n    return JSONResponse(\n        status_code=exc.status_code,\n        content={\n            \"path\": request.url.path,\n            \"timestamp\": format_datetime(datetime.now(timezone.utc)),\n            \"status\": exc.status_code,\n            \"error\": http.HTTPStatus(exc.status_code).phrase,\n            \"code\": exc.code,\n            \"message\": exc.detail,\n            \"params\": [],\n        },\n    )\n\n\n@fastapi_app.exception_handler(500)\nasync def internal_exception_handler(request: Request, exc):\n    if isinstance(exc, BaseError):\n        return await custom_exception_handler(request, exc)\n    status_code = getattr(exc, 'status_code', 500)  # Use 500 as default if status_code doesn't exist\n    return JSONResponse(status_code=status_code, content={\"detail\": exc.detail})\n\n \n\n\n####################################################################\nasync def answer_generator(question: str):\n    try:\n        question = question.strip()\n\n        async for messages in super_graph.astream(\n            {\n                \"messages\": [\n                    (\"user\", question)\n                ],\n            },\n            {\"recursion_limit\": 150},\n            stream_mode=\"messages\"\n        ):\n            \n            checkpoint_ns:str = messages[1][\"checkpoint_ns\"]\n            is_cared_checkpoints = checkpoint_ns.startswith(\"search:\") or checkpoint_ns.startswith(\"note_taker:\")\n            if True or is_cared_checkpoints:\n                for msg in messages:\n                    if isinstance(msg, AIMessageChunk):\n                        content = msg.content\n                        if content:\n                            #print(content, end=\"\", flush=True)\n                            escaped_content = content.replace(\"\\n\", \"\\\\n\")\n                            yield f\"data: {escaped_content}\\n\\n\"\n                #await asyncio.sleep(0)\n    except Exception as e:\n        yield f\"data: [Error] {str(e)}\\n\\n\"\n    yield \"data: [DONE]\\n\\n\"\n\n\n\n@fastapi_app.get(\"/rest/v1/question\")\nasync def submit_question(request: Request, question: str):\n    async def event_stream():\n        try:\n            async for data in answer_generator(question):\n                if await request.is_disconnected():\n                    break\n                yield data\n        except Exception as e:\n            yield f\"data: [Error] {str(e)}\\n\\n\"\n\n    return StreamingResponse(event_stream(), media_type=\"text/event-stream\")\n",
    "original_code": "from datetime import datetime, timezone\nimport http\nimport os\nfrom logging import Logger\nfrom langchain_core.messages import AIMessageChunk\nfrom fastapi import FastAPI, Request\nfrom fastapi.responses import JSONResponse, StreamingResponse\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom starlette.middleware.base import BaseHTTPMiddleware\n\n\nfrom dotenv import load_dotenv\nfrom misc import format_datetime\nfrom errs import BaseError\nfrom log import get_logger\nfrom graph import super_graph\n\nload_dotenv(dotenv_path=os.path.join(os.getcwd(), \".env\"))\n\n\nclass LoggingMiddleware(BaseHTTPMiddleware):\n    logger: Logger = get_logger(\"api\")\n\n    async def dispatch(self, request, call_next):\n        self.logger.info(\"Request body: %s\", await request.body())\n        resp = await call_next(request)\n        return resp\n    \n\nfastapi_app = FastAPI(validate_responses=False)\nfastapi_app.add_middleware(LoggingMiddleware)\nfastapi_app.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"], \n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n@fastapi_app.exception_handler(BaseError)\nasync def custom_exception_handler(request: Request, exc: BaseError):\n    return JSONResponse(\n        status_code=exc.status_code,\n        content={\n            \"path\": request.url.path,\n            \"timestamp\": format_datetime(datetime.now(timezone.utc)),\n            \"status\": exc.status_code,\n            \"error\": http.HTTPStatus(exc.status_code).phrase,\n            \"code\": exc.code,\n            \"message\": exc.detail,\n            \"params\": [],\n        },\n    )\n\n\n@fastapi_app.exception_handler(500)\nasync def internal_exception_handler(request: Request, exc):\n    if isinstance(exc, BaseError):\n        return await custom_exception_handler(request, exc)\n    return JSONResponse(status_code=exc.status_code, content={\"detail\": exc.detail})\n\n \n\n\n####################################################################\nasync def answer_generator(question: str):\n    try:\n        question = question.strip()\n\n        async for messages in super_graph.astream(\n            {\n                \"messages\": [\n                    (\"user\", question)\n                ],\n            },\n            {\"recursion_limit\": 150},\n            stream_mode=\"messages\"\n        ):\n            \n            checkpoint_ns:str = messages[1][\"checkpoint_ns\"]\n            is_cared_checkpoints = checkpoint_ns.startswith(\"search:\") or checkpoint_ns.startswith(\"note_taker:\")\n            if True or is_cared_checkpoints:\n                for msg in messages:\n                    if isinstance(msg, AIMessageChunk):\n                        content = msg.content\n                        if content:\n                            #print(content, end=\"\", flush=True)\n                            escaped_content = content.replace(\"\\n\", \"\\\\n\")\n                            yield f\"data: {escaped_content}\\n\\n\"\n                #await asyncio.sleep(0)\n    except Exception as e:\n        yield f\"data: [Error] {str(e)}\\n\\n\"\n    yield \"data: [DONE]\\n\\n\"\n\n\n\n@fastapi_app.get(\"/rest/v1/question\")\nasync def submit_question(request: Request, question: str):\n    async def event_stream():\n        try:\n            async for data in answer_generator(question):\n                if await request.is_disconnected():\n                    break\n                yield data\n        except Exception as e:\n            yield f\"data: [Error] {str(e)}\\n\\n\"\n\n    return StreamingResponse(event_stream(), media_type=\"text/event-stream\")\n",
    "path": "backend/api.py",
    "model_usage_metrics": {
        "Duration": 11175050078,
        "OpenAiUsage": {
            "completion_tokens": 0,
            "prompt_tokens": 0,
            "total_tokens": 0,
            "completion_tokens_details": {
                "accepted_prediction_tokens": 0,
                "audio_tokens": 0,
                "reasoning_tokens": 0,
                "rejected_prediction_tokens": 0
            },
            "prompt_tokens_details": {
                "audio_tokens": 0,
                "cached_tokens": 0
            }
        }
    }
}